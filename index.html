<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–î–Ω–µ–≤–Ω–∏–∫</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      padding: 18px;
      background: #f4f4f4;
      color: #111;
    }
    .card {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 16px;
      max-width: 700px;
      margin: 0 auto 12px auto;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 12px 0;
    }
    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d8d8d8;
      font-size: 14px;
      box-sizing: border-box;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #d8d8d8;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    button.primary {
      border-color: #cfcfcf;
      font-weight: 600;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
      color: #2d7a2d;
      min-height: 18px;
    }
    .muted {
      color: #666;
      font-size: 13px;
    }
    ul {
      padding-left: 18px;
      margin: 8px 0 0 0;
    }
    li {
      margin: 6px 0;
      line-height: 1.35;
    }
    .date {
      color: #777;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .divider {
      height: 1px;
      background: #eee;
      margin: 10px 0;
    }

    /* –í–ê–ñ–ù–û –î–õ–Ø TELEGRAM WEBVIEW: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –≤ followup */
    #followup, #followupOptions {
      position: relative;
      z-index: 9999;
      pointer-events: auto;
    }
    .optionBtn {
      pointer-events: auto;
      position: relative;
      z-index: 10000;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .optionBtn.active {
      border: 2px solid #2f80ed;
      font-weight: 700;
    }

    /* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –î–∞/–ù–µ—Ç */
    #trainYes.active,
    #trainNo.active {
      border: 2px solid #2f80ed;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <!-- –®–∞–≥ 1 -->
  <div class="card" id="step1">
    <h1>–ö–∞–∫ —Ç—ã —Å–µ–±—è —Å–µ–≥–æ–¥–Ω—è —á—É–≤—Å—Ç–≤—É–µ—à—å?</h1>

    <textarea id="answer" placeholder="–ù–∞–ø–∏—à–∏ –ø–∞—Ä—É —Å–ª–æ–≤..."></textarea>

    <div class="row">
      <button class="primary" id="saveBtn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="clearBtn" type="button">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>

    <div class="status" id="status"></div>
    <div class="muted" id="lastSaved"></div>
  </div>

  <!-- –®–∞–≥ 2 -->
  <div class="card" id="step2" style="display:none;">
    <h1>–ë—ã–ª–∞ –ª–∏ —Å–µ–≥–æ–¥–Ω—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?</h1>

    <div class="row">
      <button id="trainYes" type="button">–î–∞</button>
      <button id="trainNo" type="button">–ù–µ—Ç</button>
    </div>

    <div id="followup" style="display:none; margin-top: 12px;">
      <div class="muted" id="followupTitle" style="margin-bottom: 8px;"></div>
      <div class="row" id="followupOptions"></div>

      <div class="row" style="margin-top: 10px;">
        <button class="primary" id="finishBtn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="backBtn" type="button">–ù–∞–∑–∞–¥</button>
      </div>
    </div>
  </div>

  <!-- –ò—Å—Ç–æ—Ä–∏—è -->
  <div class="card">
    <div class="muted">–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π)</div>
    <div class="divider"></div>
    <ul id="history"></ul>
  </div>

  <script>
   
    // ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ =====
    let pendingEntry = null;

    // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è =====
    const STORAGE_KEY = "mental_checkins_v1";
    const MAX_ITEMS = 20;

    // ===== –£—Ç–∏–ª–∏—Ç—ã =====
    function nowIso() {
      return new Date().toISOString();
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleString("ru-RU", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function loadItems() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveItems(items) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    // ===== UI =====
    function setStatus(msg) {
      const el = document.getElementById("status");
      el.textContent = msg;
      setTimeout(() => { el.textContent = ""; }, 1800);
    }

    // ===== –û—Ç—Ä–∏—Å–æ–≤–∫–∞ =====
    function render() {
      const items = loadItems();

      const lastSavedEl = document.getElementById("lastSaved");
      const last = items[0];
      lastSavedEl.textContent = last
        ? `–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å: ${formatDate(last.ts)}`
        : "–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.";

      const ul = document.getElementById("history");
      ul.innerHTML = "";

      items.slice(0, MAX_ITEMS).forEach((it) => {
        const li = document.createElement("li");

        const date = document.createElement("div");
        date.className = "date";
        date.textContent = formatDate(it.ts);

        const text = document.createElement("div");
        let extra = "";
        if (it.training === true) extra = ` (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: –¥–∞, —Å—Ç–∞–ª–æ: ${it.trainingEffect || "‚Äî"})`;
        if (it.training === false) extra = ` (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: –Ω–µ—Ç, –ø—Ä–∏—á–∏–Ω–∞: ${it.trainingWhy || "‚Äî"})`;
        text.textContent = it.text + extra;

        li.appendChild(date);
        li.appendChild(text);
        ul.appendChild(li);
      });
    }

    // ===== –®–∞–≥ 1 =====
    function onSave() {
      const text = document.getElementById("answer").value.trim();
      if (!text) {
        setStatus("–ù–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤ üôÇ");
        return;
      }

      pendingEntry = {
        ts: nowIso(),
        text,
        training: null,
        trainingEffect: null,
        trainingWhy: null
      };

      // —Å–±—Ä–æ—Å —à–∞–≥ 2
      document.getElementById("trainYes").classList.remove("active");
      document.getElementById("trainNo").classList.remove("active");
      document.getElementById("followup").style.display = "none";
      document.getElementById("followupTitle").textContent = "";
      document.getElementById("followupOptions").innerHTML = "";

      document.getElementById("step2").style.display = "block";
      setStatus("–û–∫–µ–π, –µ—â—ë –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å üëá");
    }

    function onClear() {
      const ok = confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      setStatus("–û—á–∏—â–µ–Ω–æ");
      render();
    }

    // ===== Followup =====
    function showFollowup(title, options, onPick) {
      const followup = document.getElementById("followup");
      const titleEl = document.getElementById("followupTitle");
      const optsEl = document.getElementById("followupOptions");

      titleEl.textContent = title;
      optsEl.innerHTML = "";

      options.forEach((label) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "optionBtn";
        b.textContent = label;

        // onclick ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –≤ Telegram WebView
        b.onclick = () => {
          optsEl.querySelectorAll(".optionBtn").forEach(x => x.classList.remove("active"));
          b.classList.add("active");

          onPick(label);
          setStatus("–û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å –∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å¬ª ‚úì");
        };

        optsEl.appendChild(b);
      });

      followup.style.display = "block";
    }

    // ===== –î–∞ =====
    document.getElementById("trainYes").addEventListener("click", () => {
      if (!pendingEntry) return;

      pendingEntry.training = true;
      pendingEntry.trainingWhy = null;
      pendingEntry.trainingEffect = null;

      document.getElementById("trainYes").classList.add("active");
      document.getElementById("trainNo").classList.remove("active");

      showFollowup(
        "–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ç–µ–±–µ —Å—Ç–∞–ª–æ‚Ä¶",
        ["–õ—É—á—à–µ", "–¢–∞–∫ –∂–µ", "–•—É–∂–µ"],
        (picked) => { pendingEntry.trainingEffect = picked; }
      );
    });

    // ===== –ù–µ—Ç =====
    document.getElementById("trainNo").addEventListener("click", () => {
      if (!pendingEntry) return;

      pendingEntry.training = false;
      pendingEntry.trainingEffect = null;
      pendingEntry.trainingWhy = null;

      document.getElementById("trainNo").classList.add("active");
      document.getElementById("trainYes").classList.remove("active");

      showFollowup(
        "–ü–æ—á–µ–º—É –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å?",
        ["–ù–µ –±—ã–ª–æ —Å–∏–ª", "–ù–µ –±—ã–ª–æ –≤—Ä–µ–º–µ–Ω–∏", "–ù–µ –±—ã–ª–æ –∂–µ–ª–∞–Ω–∏—è", "–ë–æ–ª–µ–ª/—Ç—Ä–∞–≤–º–∞", "–î—Ä—É–≥–æ–µ"],
        (picked) => { pendingEntry.trainingWhy = picked; }
      );
    });

    // ===== –ù–∞–∑–∞–¥ =====
    document.getElementById("backBtn").addEventListener("click", () => {
      document.getElementById("step2").style.display = "none";
      document.getElementById("followup").style.display = "none";
      setStatus("–û–∫, –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞–∑–∞–¥ üôÇ");
    });

    // ===== –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ =====
    document.getElementById("finishBtn").addEventListener("click", () => {
      if (!pendingEntry) return;

      if (pendingEntry.training === true && !pendingEntry.trainingEffect) {
        setStatus("–í—ã–±–µ—Ä–∏: –ª—É—á—à–µ / —Ç–∞–∫ –∂–µ / —Ö—É–∂–µ üôÇ");
        return;
      }
      if (pendingEntry.training === false && !pendingEntry.trainingWhy) {
        setStatus("–í—ã–±–µ—Ä–∏ –ø—Ä–∏—á–∏–Ω—É üôÇ");
        return;
      }
      if (pendingEntry.training === null) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—å: –±—ã–ª–∞ –ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ üôÇ");
        return;
      }

      const items = loadItems();
      items.unshift(pendingEntry);
      saveItems(items);

      pendingEntry = null;

      document.getElementById("answer").value = "";
      document.getElementById("step2").style.display = "none";
      document.getElementById("followup").style.display = "none";

      try {
        const tg = window.Telegram?.WebApp;
        tg?.HapticFeedback?.notificationOccurred?.("success");
        tg?.ready?.();
      } catch {}

      setStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì");
      render();
    });

    // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
    document.getElementById("saveBtn").addEventListener("click", onSave);
    document.getElementById("clearBtn").addEventListener("click", onClear);
    render();
  </script>
</body>
</html>
