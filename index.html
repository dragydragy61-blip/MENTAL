<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–î–Ω–µ–≤–Ω–∏–∫</title>

  <!-- Telegram WebApp API (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–∞–ª—å—à–µ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      padding: 18px;
      background: #f4f4f4;
      color: #111;
    }
    .card {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 16px;
      max-width: 700px;
      margin: 0 auto 12px auto;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 12px 0;
    }
    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d8d8d8;
      font-size: 14px;
      box-sizing: border-box;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #d8d8d8;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    button.primary {
      border-color: #cfcfcf;
      font-weight: 600;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
      color: #2d7a2d;
      min-height: 18px;
    }
    .muted {
      color: #666;
      font-size: 13px;
    }
    ul {
      padding-left: 18px;
      margin: 8px 0 0 0;
    }
    li {
      margin: 6px 0;
      line-height: 1.35;
    }
    .date {
      color: #777;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .divider {
      height: 1px;
      background: #eee;
      margin: 10px 0;
    }
    #followup, #followupOptions {
  position: relative;
  z-index: 5;
  pointer-events: auto;
}

.optionBtn {
  pointer-events: auto;
  position: relative;
  z-index: 6;
}
  </style>
</head>

<body>
  <div class="card" id="step1">
    <h1>–ö–∞–∫ —Ç—ã —Å–µ–±—è —Å–µ–≥–æ–¥–Ω—è —á—É–≤—Å—Ç–≤—É–µ—à—å?</h1>

    <textarea id="answer" placeholder="–ù–∞–ø–∏—à–∏ –ø–∞—Ä—É —Å–ª–æ–≤..."></textarea>

    <div class="row">
      <button class="primary" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>

    <div class="status" id="status"></div>
    <div class="muted" id="lastSaved"></div>
  </div>
  <div class="card" id="step2" style="display:none;">
  <h1>–ë—ã–ª–∞ –ª–∏ —Å–µ–≥–æ–¥–Ω—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?</h1>

  <div class="row">
    <button class="primary" id="trainYes">–î–∞</button>
    <button id="trainNo">–ù–µ—Ç</button>
  </div>

  <div id="followup" style="display:none; margin-top: 12px;">
    <div class="muted" id="followupTitle" style="margin-bottom: 8px;"></div>

    <div class="row" id="followupOptions"></div>

    <div class="row" style="margin-top: 10px;">
      <button class="primary" id="finishBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      <button id="backBtn">–ù–∞–∑–∞–¥</button>
    </div>
  </div>
</div>

  <div class="card">
    <div class="muted">–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π)</div>
    <div class="divider"></div>
    <ul id="history"></ul>
  </div>

  <script>
    let pendingEntry = null;
    // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è =====
    const STORAGE_KEY = "mental_checkins_v1";
    const MAX_ITEMS = 20;
    

    // ===== –£—Ç–∏–ª–∏—Ç—ã =====
    function nowIso() {
      return new Date().toISOString();
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleString("ru-RU", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    }

    function loadItems() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveItems(items) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    // ===== –û—Ç—Ä–∏—Å–æ–≤–∫–∞ =====
    function render() {
      const items = loadItems();

      // –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å
      const last = items[0];
      const lastSavedEl = document.getElementById("lastSaved");
      if (last) {
        lastSavedEl.textContent = `–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å: ${formatDate(last.ts)}`;
      } else {
        lastSavedEl.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.";
      }

      // –ò—Å—Ç–æ—Ä–∏—è
      const ul = document.getElementById("history");
      ul.innerHTML = "";
      items.slice(0, MAX_ITEMS).forEach((it) => {
        const li = document.createElement("li");

        const date = document.createElement("div");
        date.className = "date";
        date.textContent = formatDate(it.ts);

        const text = document.createElement("div");
        text.textContent = it.text;

        li.appendChild(date);
        li.appendChild(text);
        ul.appendChild(li);
      });
    }

    // ===== –î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è =====
    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
      setTimeout(() => {
        document.getElementById("status").textContent = "";
      }, 1800);
    }

    function onSave() {
  const text = document.getElementById("answer").value.trim();
  if (!text) {
    setStatus("–ù–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤ üôÇ");
    return;
  }

  // —Å–æ–∑–¥–∞—ë–º —á–µ—Ä–Ω–æ–≤–∏–∫
  pendingEntry = {
    ts: nowIso(),
    text,
    training: null,
    trainingEffect: null,
    trainingWhy: null
  };

  // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
  document.getElementById("step2").style.display = "block";
  document.getElementById("followup").style.display = "none";

  setStatus("–û–∫–µ–π, –µ—â—ë –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å üëá");
}

    function onClear() {
      const ok = confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      setStatus("–û—á–∏—â–µ–Ω–æ");
      render();
    }
    function showFollowup(title, options, onPick) {
  const followup = document.getElementById("followup");
  const titleEl = document.getElementById("followupTitle");
  const optsEl = document.getElementById("followupOptions");

  titleEl.textContent = title;
  optsEl.innerHTML = "";

  options.forEach((label) => {
    const b = document.createElement("button");
    b.textContent = label;
    b.className = "optionBtn";
    b.addEventListener("click", () => onPick(label));
    setStatus("–û—Ç–ª–∏—á–Ω–æ, –º–æ–∂–µ—à—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å ‚úì");
    optsEl.appendChild(b);
  });

  followup.style.display = "block";
}

document.getElementById("trainYes").addEventListener("click", () => {
  if (!pendingEntry) return;

  pendingEntry.training = true;
  showFollowup(
    "–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ç–µ–±–µ —Å—Ç–∞–ª–æ‚Ä¶",
    ["–õ—É—á—à–µ", "–¢–∞–∫ –∂–µ", "–•—É–∂–µ"],
    (picked) => { pendingEntry.trainingEffect = picked; }
  );
});

document.getElementById("trainNo").addEventListener("click", () => {
  if (!pendingEntry) return;

  pendingEntry.training = false;
  showFollowup(
    "–ü–æ—á–µ–º—É –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å?",
    ["–ù–µ –±—ã–ª–æ —Å–∏–ª", "–ù–µ –±—ã–ª–æ –≤—Ä–µ–º–µ–Ω–∏", "–ù–µ –±—ã–ª–æ –∂–µ–ª–∞–Ω–∏—è", "–ë–æ–ª–µ–ª/—Ç—Ä–∞–≤–º–∞", "–î—Ä—É–≥–æ–µ"],
    (picked) => { pendingEntry.trainingWhy = picked; }
  );
});

document.getElementById("backBtn").addEventListener("click", () => {
  document.getElementById("step2").style.display = "none";
  document.getElementById("followup").style.display = "none";
});

document.getElementById("finishBtn").addEventListener("click", () => {
  if (!pendingEntry) return;

  // –ø—Ä–æ–≤–µ—Ä–∫–∞: –≤—ã–±—Ä–∞–ª–∏ –ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ
  if (pendingEntry.training === true && !pendingEntry.trainingEffect) {
    setStatus("–í—ã–±–µ—Ä–∏: –ª—É—á—à–µ/—Ç–∞–∫ –∂–µ/—Ö—É–∂–µ üôÇ");
    return;
  }
  if (pendingEntry.training === false && !pendingEntry.trainingWhy) {
    setStatus("–í—ã–±–µ—Ä–∏ –ø—Ä–∏—á–∏–Ω—É üôÇ");
    return;
  }

  const items = loadItems();
  items.unshift(pendingEntry);
  saveItems(items);

  pendingEntry = null;

  document.getElementById("answer").value = "";
  document.getElementById("step2").style.display = "none";
  document.getElementById("followup").style.display = "none";

  setStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì");
  render();
});

    // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
    document.getElementById("saveBtn").addEventListener("click", onSave);
    document.getElementById("clearBtn").addEventListener("click", onClear);

    render();
  </script>
</body>
</html>
